<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ger√ßek Alev Tespit Sistemi</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: Arial, sans-serif;
            background: #0d1b2a;
            color: white;
            padding: 20px;
            min-height: 100vh;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        header {
            text-align: center;
            margin-bottom: 30px;
            padding: 25px;
            background: rgba(255, 87, 51, 0.15);
            border-radius: 15px;
            border: 2px solid rgba(255, 87, 51, 0.3);
        }
        h1 { 
            color: #ff5722; 
            margin-bottom: 10px; 
            font-size: 2.5em;
            text-shadow: 0 2px 10px rgba(255, 87, 51, 0.5);
        }
        .subtitle {
            color: #4fc3f7;
            font-size: 1.2em;
        }
        
        .main-content {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin-bottom: 30px;
        }
        
        @media (max-width: 1000px) {
            .main-content { grid-template-columns: 1fr; }
        }
        
        .panel {
            background: rgba(25, 35, 55, 0.8);
            border-radius: 15px;
            padding: 25px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        }
        
        .panel-title {
            color: #4fc3f7;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid #4fc3f7;
            font-size: 1.4em;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .camera-view {
            width: 100%;
            height: 400px;
            background: #000;
            border-radius: 10px;
            overflow: hidden;
            margin-bottom: 20px;
            position: relative;
            border: 2px solid rgba(255, 255, 255, 0.1);
        }
        
        #videoElement {
            width: 100%;
            height: 100%;
            object-fit: cover;
            transform: scaleX(-1); /* Ayna efekti */
        }
        
        #analysisCanvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
        }
        
        .controls {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin-bottom: 20px;
        }
        
        .control-btn {
            padding: 15px;
            border: none;
            border-radius: 8px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        
        #startBtn {
            background: linear-gradient(135deg, #00c853, #00e676);
            color: white;
        }
        
        #stopBtn {
            background: linear-gradient(135deg, #ff3d00, #ff5722);
            color: white;
        }
        
        #detectBtn {
            background: linear-gradient(135deg, #2979ff, #2962ff);
            color: white;
        }
        
        .control-btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
        }
        
        .control-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none !important;
        }
        
        .camera-select {
            width: 100%;
            padding: 12px;
            margin-bottom: 20px;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: white;
            border-radius: 8px;
            font-size: 16px;
        }
        
        .grid-container {
            display: grid;
            grid-template-columns: repeat(8, 1fr);
            grid-template-rows: repeat(8, 1fr);
            gap: 2px;
            width: 100%;
            aspect-ratio: 1 / 1;
            background: rgba(0, 0, 0, 0.3);
            padding: 10px;
            border-radius: 10px;
            margin-bottom: 25px;
            border: 2px solid rgba(255, 255, 255, 0.1);
        }
        
        .grid-cell {
            background: rgba(255, 255, 255, 0.08);
            border-radius: 3px;
            position: relative;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            overflow: hidden;
        }
        
        .grid-cell.fire-detected {
            background: linear-gradient(135deg, 
                rgba(255, 87, 34, 0.95), 
                rgba(255, 61, 0, 0.9));
            box-shadow: 
                0 0 20px rgba(255, 87, 34, 0.8),
                inset 0 0 30px rgba(255, 193, 7, 0.4);
            border: 1px solid rgba(255, 235, 59, 0.5);
            animation: fireGlow 1.5s ease-in-out infinite alternate;
            z-index: 2;
        }
        
        @keyframes fireGlow {
            0% {
                box-shadow: 
                    0 0 15px rgba(255, 87, 34, 0.7),
                    inset 0 0 20px rgba(255, 193, 7, 0.3);
                transform: scale(1);
            }
            100% {
                box-shadow: 
                    0 0 30px rgba(255, 87, 34, 1),
                    inset 0 0 40px rgba(255, 193, 7, 0.6);
                transform: scale(1.05);
            }
        }
        
        .cell-info {
            position: absolute;
            bottom: 3px;
            right: 3px;
            font-size: 9px;
            background: rgba(0, 0, 0, 0.7);
            padding: 2px 4px;
            border-radius: 2px;
            color: #fff;
            font-weight: bold;
        }
        
        .stats {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin-top: 20px;
        }
        
        .stat-card {
            background: rgba(255, 255, 255, 0.05);
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .stat-value {
            font-size: 28px;
            font-weight: bold;
            color: #ffeb3b;
            margin-bottom: 5px;
        }
        
        .stat-label {
            font-size: 13px;
            color: rgba(255, 255, 255, 0.7);
        }
        
        .settings {
            background: rgba(255, 255, 255, 0.05);
            padding: 20px;
            border-radius: 10px;
            margin-top: 20px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .threshold-control {
            margin-bottom: 15px;
        }
        
        .threshold-control label {
            display: block;
            margin-bottom: 10px;
            color: #4fc3f7;
            font-weight: bold;
        }
        
        #thresholdSlider {
            width: 100%;
            height: 10px;
            -webkit-appearance: none;
            background: linear-gradient(to right, #00c853, #ffeb3b, #ff5722);
            border-radius: 5px;
            outline: none;
        }
        
        #thresholdSlider::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 24px;
            height: 24px;
            background: white;
            border-radius: 50%;
            cursor: pointer;
            border: 3px solid #2979ff;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
        }
        
        .status-indicator {
            padding: 15px;
            border-radius: 10px;
            text-align: center;
            font-weight: bold;
            margin-top: 20px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            background: rgba(0, 0, 0, 0.2);
            transition: all 0.3s;
        }
        
        .status-active {
            background: rgba(0, 200, 83, 0.2);
            color: #00e676;
            border-color: rgba(0, 200, 83, 0.3);
            animation: pulse 2s infinite;
        }
        
        .status-warning {
            background: rgba(255, 193, 7, 0.2);
            color: #ffeb3b;
            border-color: rgba(255, 193, 7, 0.3);
        }
        
        .status-danger {
            background: rgba(255, 87, 34, 0.2);
            color: #ff5722;
            border-color: rgba(255, 87, 34, 0.3);
            animation: dangerPulse 1s infinite;
        }
        
        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(0, 200, 83, 0.4); }
            70% { box-shadow: 0 0 0 10px rgba(0, 200, 83, 0); }
            100% { box-shadow: 0 0 0 0 rgba(0, 200, 83, 0); }
        }
        
        @keyframes dangerPulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }
        
        .debug-info {
            font-size: 12px;
            color: rgba(255, 255, 255, 0.5);
            margin-top: 10px;
            padding: 10px;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 5px;
            font-family: monospace;
        }
        
        .model-info {
            background: rgba(41, 121, 255, 0.1);
            padding: 15px;
            border-radius: 10px;
            margin-top: 15px;
            border-left: 4px solid #2979ff;
        }
        
        .warning-box {
            background: rgba(255, 193, 7, 0.1);
            padding: 15px;
            border-radius: 10px;
            margin-top: 15px;
            border-left: 4px solid #ffc107;
            color: #ffeb3b;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>üî• GER√áEK ALEV TESPƒ∞T Sƒ∞STEMƒ∞</h1>
            <p class="subtitle">Sadece ger√ßek alevler tespit edilir - Rastgele yanma YOK!</p>
        </header>
        
        <div class="main-content">
            <div class="panel">
                <div class="panel-title">üì∑ KAMERA VE KONTROLLER</div>
                
                <div class="camera-view">
                    <video id="videoElement" autoplay playsinline></video>
                    <canvas id="analysisCanvas"></canvas>
                </div>
                
                <select id="cameraSelect" class="camera-select">
                    <option value="">Kamera y√ºkleniyor...</option>
                </select>
                
                <div class="controls">
                    <button id="startBtn" class="control-btn">
                        <span>‚ñ∂Ô∏è</span> KAMERA A√á
                    </button>
                    <button id="stopBtn" class="control-btn" disabled>
                        <span>‚èπÔ∏è</span> KAPAT
                    </button>
                    <button id="detectBtn" class="control-btn" disabled>
                        <span>üî•</span> TESPƒ∞T BA≈ûLAT
                    </button>
                </div>
                
                <div class="settings">
                    <div class="threshold-control">
                        <label>üìä Tespit Hassasiyeti: <span id="thresholdValue">%70</span></label>
                        <input type="range" id="thresholdSlider" min="50" max="95" value="70">
                    </div>
                </div>
                
                <div id="statusMessage" class="status-indicator">
                    <span class="loading">‚è≥</span> Sistem hazƒ±rlanƒ±yor...
                </div>
                
                <div class="model-info">
                    <strong>ü§ñ MODEL DURUMU:</strong>
                    <div id="modelStatus">Teachable Machine modeli y√ºkleniyor...</div>
                </div>
                
                <div class="warning-box">
                    <strong>‚ö†Ô∏è UYARI:</strong> 
                    Sistem sadece ger√ßek alevleri tespit eder. Rastgele yanma yapmaz. 
                    Alev g√∂stermezseniz grid yanmayacaktƒ±r.
                </div>
            </div>
            
            <div class="panel">
                <div class="panel-title">üß≠ 8x8 ALEV ANALƒ∞Z GRƒ∞Dƒ∞</div>
                
                <div class="grid-container" id="gridContainer">
                    <!-- Grid h√ºcreleri buraya gelecek -->
                </div>
                
                <div class="stats">
                    <div class="stat-card">
                        <div class="stat-value" id="fireCount">0</div>
                        <div class="stat-label">ALEVLƒ∞ H√úCRE</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="detectionRate">%0</div>
                        <div class="stat-label">TESPƒ∞T ORANI</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="lastUpdate">--:--</div>
                        <div class="stat-label">SON G√úNCELLEME</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="avgConfidence">%0</div>
                        <div class="stat-label">ORTALAMA G√úVEN</div>
                    </div>
                </div>
                
                <div class="debug-info">
                    <strong>DEBUG:</strong> 
                    <span id="debugText">Sistem ba≈ülatƒ±lƒ±yor...</span>
                </div>
            </div>
        </div>
    </div>

    <!-- TensorFlow.js ve Teachable Machine -->
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@1.7.4/dist/tf.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@teachablemachine/image@0.8/dist/teachablemachine-image.min.js"></script>
    
    <script>
        // ========== Sƒ∞STEM KONFƒ∞G√úRASYONU ==========
        const CONFIG = {
            grid: {
                size: 8,
                cellSize: 28 // 224 / 8
            },
            detection: {
                threshold: 0.7, // Ba≈ülangƒ±√ß e≈üiƒüi %70
                interval: 1000, // 1 saniyede bir tespit
                minConfidence: 0.1 // Minimum g√ºven deƒüeri
            }
        };

        // ========== DOM ELEMENTLERƒ∞ ==========
        const video = document.getElementById('videoElement');
        const canvas = document.getElementById('analysisCanvas');
        const cameraSelect = document.getElementById('cameraSelect');
        const startBtn = document.getElementById('startBtn');
        const stopBtn = document.getElementById('stopBtn');
        const detectBtn = document.getElementById('detectBtn');
        const statusMessage = document.getElementById('statusMessage');
        const thresholdSlider = document.getElementById('thresholdSlider');
        const thresholdValue = document.getElementById('thresholdValue');
        const gridContainer = document.getElementById('gridContainer');
        const fireCountEl = document.getElementById('fireCount');
        const detectionRateEl = document.getElementById('detectionRate');
        const lastUpdateEl = document.getElementById('lastUpdate');
        const avgConfidenceEl = document.getElementById('avgConfidence');
        const debugText = document.getElementById('debugText');
        const modelStatus = document.getElementById('modelStatus');

        // ========== Sƒ∞STEM DEƒûƒ∞≈ûKENLERƒ∞ ==========
        let model = null;
        let currentStream = null;
        let isDetecting = false;
        let detectionInterval = null;
        let threshold = CONFIG.detection.threshold;
        let gridCells = [];
        let lastDetectionTime = 0;

        // ========== TEACHABLE MACHINE MODELƒ∞ Y√úKLEME ==========
        async function loadModel() {
            try {
                debugLog('Teachable Machine modeli y√ºkleniyor...');
                modelStatus.textContent = '‚è≥ Model y√ºkleniyor...';
                modelStatus.style.color = '#ffc107';
                
                // MODEL DOSYALARINIZI KULLANIYOR
                const modelURL = 'model.json';
                const metadataURL = 'metadata.json';
                
                // Teachable Machine modelini y√ºkle
                model = await tmImage.load(modelURL, metadataURL);
                
                // Model bilgilerini al
                const classLabels = model.getClassLabels();
                debugLog(`Model y√ºklendi! Sƒ±nƒ±flar: ${classLabels.join(', ')}`);
                
                // Model bilgilerini g√∂ster
                modelStatus.innerHTML = `
                    ‚úÖ <strong>Model Y√ºklendi!</strong><br>
                    <small>Sƒ±nƒ±flar: <strong>${classLabels[0]}</strong> vs <strong>${classLabels[1]}</strong></small>
                `;
                modelStatus.style.color = '#00e676';
                
                statusMessage.innerHTML = '‚úÖ MODEL HAZIR! Kamerayƒ± a√ßƒ±n';
                statusMessage.className = 'status-indicator status-active';
                
                return true;
                
            } catch (error) {
                console.error('Model y√ºkleme hatasƒ±:', error);
                debugLog(`‚ùå Model hatasƒ±: ${error.message}`);
                modelStatus.textContent = '‚ùå Model y√ºklenemedi!';
                modelStatus.style.color = '#ff5722';
                
                statusMessage.innerHTML = '‚ùå MODEL Y√úKLENEMEDƒ∞!';
                statusMessage.className = 'status-indicator status-danger';
                
                alert('HATA: Teachable Machine modeli y√ºklenemedi!\n\n' +
                      'L√ºtfen kontrol edin:\n' +
                      '1. model.json dosyasƒ± var mƒ±?\n' +
                      '2. metadata.json dosyasƒ± var mƒ±?\n' +
                      '3. weights.bin dosyasƒ± var mƒ±?\n' +
                      '4. T√ºm dosyalar aynƒ± klas√∂rde mi?');
                return false;
            }
        }

        // ========== KAMERA ƒ∞≈ûLEMLERƒ∞ ==========
        async function startCamera(deviceId = '') {
            try {
                debugLog('Kamera ba≈ülatƒ±lƒ±yor...');
                updateStatus('Kamera a√ßƒ±lƒ±yor...', 'warning');
                
                // √ñnceki stream'i temizle
                if (currentStream) {
                    currentStream.getTracks().forEach(track => track.stop());
                }
                
                // Kamera kƒ±sƒ±tlamalarƒ±
                const constraints = {
                    video: {
                        width: { ideal: 640 },
                        height: { ideal: 480 },
                        frameRate: { ideal: 30 },
                        facingMode: 'environment'
                    },
                    audio: false
                };
                
                // Belirli kamera se√ßilmi≈üse
                if (deviceId) {
                    constraints.video.deviceId = { exact: deviceId };
                }
                
                // Kamerayƒ± a√ß
                currentStream = await navigator.mediaDevices.getUserMedia(constraints);
                video.srcObject = currentStream;
                
                // Canvas boyutlarƒ±nƒ± ayarla
                await waitForVideoReady();
                canvas.width = video.videoWidth;
                canvas.height = video.videoHeight;
                
                debugLog(`Kamera a√ßƒ±ldƒ±: ${video.videoWidth}x${video.videoHeight}`);
                updateStatus('‚úÖ KAMERA HAZIR!', 'active');
                
                // Butonlarƒ± aktif et
                startBtn.disabled = true;
                stopBtn.disabled = false;
                detectBtn.disabled = false;
                
                return true;
                
            } catch (error) {
                console.error('Kamera hatasƒ±:', error);
                let errorMsg = 'Kamera a√ßƒ±lamadƒ±: ';
                
                if (error.name === 'NotAllowedError') {
                    errorMsg = '‚ùå KAMERA ƒ∞ZNƒ∞ VERƒ∞LMEDƒ∞!\nL√ºtfen tarayƒ±cƒ± izinlerini kontrol edin.';
                } else if (error.name === 'NotFoundError') {
                    errorMsg = '‚ùå KAMERA BULUNAMADI!';
                } else if (error.name === 'NotReadableError') {
                    errorMsg = '‚ùå KAMERA KULLANIMDA!\nBa≈üka bir program kamera kullanƒ±yor olabilir.';
                } else {
                    errorMsg = `‚ùå KAMERA HATASI: ${error.message}`;
                }
                
                debugLog(errorMsg);
                updateStatus(errorMsg, 'danger');
                
                // Kamera izni i√ßin yardƒ±m g√∂ster
                setTimeout(() => {
                    alert('KAMERA ƒ∞ZNI ƒ∞√áƒ∞N:\n\n' +
                          '1. Tarayƒ±cƒ± URL √ßubuƒüundaki üîí veya üì∑ ikonuna tƒ±klayƒ±n\n' +
                          '2. "Site ayarlarƒ±" veya "ƒ∞zinler" b√∂l√ºm√ºne girin\n' +
                          '3. "Kamera" i√ßin "ƒ∞zin ver" se√ßin\n' +
                          '4. Sayfayƒ± yenileyin ve tekrar deneyin');
                }, 1000);
                
                return false;
            }
        }

        function stopCamera() {
            if (currentStream) {
                // Stream'i durdur
                currentStream.getTracks().forEach(track => {
                    track.stop();
                });
                currentStream = null;
                video.srcObject = null;
                
                // Tespiti de durdur
                stopDetection();
                
                // Butonlarƒ± g√ºncelle
                startBtn.disabled = false;
                stopBtn.disabled = true;
                detectBtn.disabled = true;
                
                debugLog('Kamera kapatƒ±ldƒ±');
                updateStatus('Kamera kapalƒ±', 'warning');
                
                // Grid'i temizle
                resetGrid();
            }
        }

        async function waitForVideoReady() {
            return new Promise((resolve) => {
                if (video.readyState >= 2) {
                    resolve();
                } else {
                    video.onloadedmetadata = () => resolve();
                }
            });
        }

        // ========== GRID OLU≈ûTURMA ==========
        function createGrid() {
            gridContainer.innerHTML = '';
            gridCells = [];
            
            for (let i = 0; i < 64; i++) {
                const cell = document.createElement('div');
                cell.className = 'grid-cell';
                cell.dataset.index = i;
                
                // H√ºcre koordinatlarƒ±
                const row = Math.floor(i / 8);
                const col = i % 8;
                
                // H√ºcre bilgisi
                const infoSpan = document.createElement('span');
                infoSpan.className = 'cell-info';
                infoSpan.textContent = `${row+1},${col+1}`;
                cell.appendChild(infoSpan);
                
                // H√ºcreye tƒ±klanƒ±nca bilgi g√∂ster
                cell.addEventListener('click', () => {
                    const prob = gridCells[i]?.probability || 0;
                    alert(`H√ºcre ${row+1},${col+1}\n` +
                          `Alev Olasƒ±lƒ±ƒüƒ±: ${Math.round(prob * 100)}%\n` +
                          `E≈üik Deƒüeri: ${Math.round(threshold * 100)}%`);
                });
                
                gridContainer.appendChild(cell);
                gridCells.push({
                    element: cell,
                    probability: 0,
                    hasFire: false
                });
            }
            
            debugLog('8x8 grid olu≈üturuldu');
        }

        // ========== ALEV TESPƒ∞T FONKSƒ∞YONLARI ==========
        async function startDetection() {
            if (!model || !currentStream) {
                alert('√ñnce model ve kamera hazƒ±r olmalƒ±!');
                return;
            }
            
            if (isDetecting) {
                stopDetection();
                return;
            }
            
            isDetecting = true;
            detectBtn.innerHTML = '<span>‚è∏Ô∏è</span> TESPƒ∞Tƒ∞ DURDUR';
            detectBtn.style.background = 'linear-gradient(135deg, #ff9800, #ff5722)';
            
            debugLog('Alev tespiti ba≈ülatƒ±ldƒ±');
            updateStatus('üî• GER√áEK ZAMANLI ALEV TESPƒ∞Tƒ∞ AKTƒ∞F', 'active');
            
            // Tespit d√∂ng√ºs√ºn√º ba≈ülat
            detectionInterval = setInterval(performDetection, CONFIG.detection.interval);
            
            // ƒ∞lk tespiti hemen yap
            setTimeout(performDetection, 100);
        }

        function stopDetection() {
            if (!isDetecting) return;
            
            isDetecting = false;
            clearInterval(detectionInterval);
            detectionInterval = null;
            
            detectBtn.innerHTML = '<span>üî•</span> TESPƒ∞T BA≈ûLAT';
            detectBtn.style.background = 'linear-gradient(135deg, #2979ff, #2962ff)';
            
            debugLog('Alev tespiti durduruldu');
            updateStatus('Tespit durduruldu', 'warning');
        }

        async function performDetection() {
            if (!isDetecting || !currentStream || !model) return;
            
            const startTime = Date.now();
            
            try {
                // Video'dan frame al
                const ctx = canvas.getContext('2d');
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
                
                // Frame'i 224x224 boyutuna k√º√ß√ºlt (model i√ßin)
                const smallCanvas = document.createElement('canvas');
                smallCanvas.width = 224;
                smallCanvas.height = 224;
                const smallCtx = smallCanvas.getContext('2d');
                smallCtx.drawImage(canvas, 0, 0, 224, 224);
                
                let totalFireCount = 0;
                let totalConfidence = 0;
                let cellsWithFire = 0;
                
                // Her h√ºcre i√ßin tahmin yap
                for (let i = 0; i < 64; i++) {
                    const cell = gridCells[i];
                    const row = Math.floor(i / 8);
                    const col = i % 8;
                    
                    // H√ºcre g√∂r√ºnt√ºs√ºn√º al (28x28 piksel)
                    const cellCanvas = document.createElement('canvas');
                    cellCanvas.width = 224; // Model i√ßin b√ºy√ºt
                    cellCanvas.height = 224;
                    const cellCtx = cellCanvas.getContext('2d');
                    
                    // H√ºcreyi 224x224 boyutuna b√ºy√ºt
                    cellCtx.drawImage(
                        smallCanvas,
                        col * 28, row * 28, 28, 28, // Kaynak
                        0, 0, 224, 224               // Hedef
                    );
                    
                    // Teachable Machine ile tahmin yap
                    const predictions = await model.predict(cellCanvas);
                    
                    // Alev sƒ±nƒ±fƒ±nƒ± bul (metadata.json'daki ilk etiket "Alev" olmalƒ±)
                    const firePrediction = predictions.find(p => p.className === "Alev");
                    const probability = firePrediction ? firePrediction.probability : 0;
                    
                    // H√ºcreyi g√ºncelle
                    cell.probability = probability;
                    
                    // E≈üik deƒüerine g√∂re alev tespiti
                    const hasFire = probability > threshold;
                    cell.hasFire = hasFire;
                    
                    // H√ºcre g√∂r√ºn√ºm√ºn√º g√ºncelle
                    if (hasFire) {
                        cell.element.classList.add('fire-detected');
                        totalFireCount++;
                        totalConfidence += probability;
                        cellsWithFire++;
                    } else {
                        cell.element.classList.remove('fire-detected');
                        // D√º≈ü√ºk olasƒ±lƒ±klarƒ± da g√∂ster (isteƒüe baƒülƒ±)
                        if (probability > CONFIG.detection.minConfidence) {
                            cell.element.style.background = `rgba(255, 193, 7, ${probability * 0.5})`;
                        } else {
                            cell.element.style.background = '';
                        }
                    }
                    
                    // H√ºcre tooltip'ini g√ºncelle
                    cell.element.title = 
                        `H√ºcre ${row+1},${col+1}\n` +
                        `Alev Olasƒ±lƒ±ƒüƒ±: ${Math.round(probability * 100)}%\n` +
                        `Durum: ${hasFire ? 'üî• ALEV VAR' : '‚úÖ TEMƒ∞Z'}\n` +
                        `E≈üik: ${Math.round(threshold * 100)}%`;
                }
                
                // ƒ∞statistikleri g√ºncelle
                updateStatistics(totalFireCount, totalConfidence, cellsWithFire);
                
                const detectionTime = Date.now() - startTime;
                debugLog(`Tespit tamamlandƒ±: ${totalFireCount} alevli h√ºcre (${detectionTime}ms)`);
                
                // Kritik durum kontrol√º
                if (totalFireCount > 0) {
                    if (totalFireCount > 10) {
                        updateStatus(`üö® ${totalFireCount} H√úCREDE ALEV TESPƒ∞T EDƒ∞LDƒ∞!`, 'danger');
                        document.title = `üö® ${totalFireCount} ALEV - ACƒ∞L!`;
                    } else {
                        updateStatus(`üî• ${totalFireCount} h√ºcrede alev tespit edildi`, 'warning');
                        document.title = `üî• ${totalFireCount} Alevli H√ºcre`;
                    }
                } else {
                    document.title = 'Alev Tespit Sistemi';
                }
                
            } catch (error) {
                console.error('Tespit hatasƒ±:', error);
                debugLog(`Tespit hatasƒ±: ${error.message}`);
                updateStatus('Tespit hatasƒ± olu≈ütu', 'danger');
            }
        }

        function updateStatistics(fireCount, totalConfidence, cellsWithFire) {
            // Alevli h√ºcre sayƒ±sƒ±
            fireCountEl.textContent = fireCount;
            
            // Tespit oranƒ±
            const detectionRate = Math.round((fireCount / 64) * 100);
            detectionRateEl.textContent = `%${detectionRate}`;
            
            // Ortalama g√ºven
            const avgConfidence = cellsWithFire > 0 
                ? Math.round((totalConfidence / cellsWithFire) * 100)
                : 0;
            avgConfidenceEl.textContent = `%${avgConfidence}`;
            
            // Son g√ºncelleme zamanƒ±
            const now = new Date();
            lastUpdateEl.textContent = now.toLocaleTimeString('tr-TR', {
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit'
            });
            
            lastDetectionTime = Date.now();
        }

        function resetGrid() {
            gridCells.forEach(cell => {
                cell.element.classList.remove('fire-detected');
                cell.element.style.background = '';
                cell.probability = 0;
                cell.hasFire = false;
            });
            
            fireCountEl.textContent = '0';
            detectionRateEl.textContent = '%0';
            avgConfidenceEl.textContent = '%0';
            lastUpdateEl.textContent = '--:--';
        }

        // ========== YARDIMCI FONKSƒ∞YONLAR ==========
        function debugLog(message) {
            console.log(message);
            debugText.textContent = message;
        }

        function updateStatus(message, type = 'warning') {
            statusMessage.innerHTML = message;
            statusMessage.className = `status-indicator status-${type}`;
        }

        async function listCameras() {
            try {
                // Kamera izni al
                const tempStream = await navigator.mediaDevices.getUserMedia({ video: true });
                tempStream.getTracks().forEach(track => track.stop());
                
                // Kamerlarƒ± listele
                const devices = await navigator.mediaDevices.enumerateDevices();
                const cameras = devices.filter(device => device.kind === 'videoinput');
                
                cameraSelect.innerHTML = '<option value="">Kamera se√ßin...</option>';
                
                cameras.forEach((camera, index) => {
                    const option = document.createElement('option');
                    option.value = camera.deviceId;
                    option.text = camera.label || `Kamera ${index + 1}`;
                    cameraSelect.appendChild(option);
                });
                
                if (cameras.length > 0) {
                    debugLog(`${cameras.length} kamera bulundu`);
                }
                
            } catch (error) {
                console.warn('Kamera listeleme hatasƒ±:', error);
                cameraSelect.innerHTML = '<option value="">Kamera izni gerekli</option>';
            }
        }

        // ========== EVENT LISTENERS ==========
        startBtn.addEventListener('click', () => {
            const deviceId = cameraSelect.value;
            startCamera(deviceId);
        });
        
        stopBtn.addEventListener('click', stopCamera);
        
        detectBtn.addEventListener('click', () => {
            if (!isDetecting) {
                startDetection();
            } else {
                stopDetection();
            }
        });
        
        cameraSelect.addEventListener('change', (e) => {
            if (e.target.value && currentStream) {
                startCamera(e.target.value);
            }
        });
        
        thresholdSlider.addEventListener('input', function() {
            threshold = this.value / 100;
            thresholdValue.textContent = `%${this.value}`;
            debugLog(`E≈üik deƒüeri g√ºncellendi: %${this.value}`);
            
            // Eƒüer tespit aktifse, yeni e≈üik deƒüeriyle hemen tespit yap
            if (isDetecting) {
                setTimeout(performDetection, 100);
            }
        });

        // ========== Sƒ∞STEM BA≈ûLATMA ==========
        async function initializeSystem() {
            debugLog('Sistem ba≈ülatƒ±lƒ±yor...');
            
            // 1. Grid olu≈ütur
            createGrid();
            
            // 2. Teachable Machine modelini y√ºkle
            const modelLoaded = await loadModel();
            if (!modelLoaded) return;
            
            // 3. Kameralarƒ± listele
            await listCameras();
            
            // 4. Sistem hazƒ±r mesajƒ±
            setTimeout(() => {
                debugLog('‚úÖ Sƒ∞STEM HAZIR! Kamerayƒ± a√ßƒ±p alev tespitine ba≈ülayabilirsiniz.');
                updateStatus('‚úÖ Sƒ∞STEM HAZIR! Kamerayƒ± a√ßƒ±n', 'active');
                
                // ƒ∞lk kamerayƒ± otomatik ba≈ülatmayƒ± dene
                if (cameraSelect.options.length > 1) {
                    debugLog('ƒ∞lk kamera otomatik ba≈ülatƒ±lƒ±yor...');
                    startBtn.click();
                }
            }, 1000);
        }

        // ========== SAYFA Y√úKLENDƒ∞ƒûƒ∞NDE ==========
        document.addEventListener('DOMContentLoaded', initializeSystem);
        
        // ========== SAYFA KAPATILIRKEN TEMƒ∞ZLƒ∞K ==========
        window.addEventListener('beforeunload', () => {
            stopDetection();
            if (currentStream) {
                currentStream.getTracks().forEach(track => track.stop());
            }
        });
    </script>
</body>
</html>